<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>AIRA Â· Analyzing the birth chartï¼ˆChatï¼‰</title>
  <!DOCTYPE html>
  <html lang="zh-CN">


  <style>
    :root {
      --bg: #0a0a0a;
      --panel: rgba(18, 18, 18, .65);
      --border: rgba(255, 255, 255, .12);
      --text: #E9E4D6;
      --muted: #ceb47b;
      --gold1: #f5c96c;
      --gold2: #e2ab58;
      --gold3: #7a5319;
      --glow: rgba(212, 168, 86, 0.247);
      --composer-h: 86px;
    }

    * {
      box-sizing: border-box
    }

    /* é˜²æ­¢ iOS èšç„¦è‡ªåŠ¨ç¼©æ”¾ï¼ˆè¦æ±‚å­—ä½“ â‰¥16pxï¼‰ */
    input,
    select,
    textarea,
    button {
      font-size: 16px;
    }

    /* ä½ é¡¹ç›®é‡Œçš„å‡ ä¸ªå…³é”®æ§ä»¶å†æ˜ç¡®ä¸€ä¸‹ */
    .toolbar select,
    .toolbar input,
    .composer textarea,
    .composer button {
      font-size: 16px;
    }

    /* è®©è¾“å…¥åŒºè´´åˆå®‰å…¨åŒºï¼Œé”®ç›˜å¼¹å‡ºæ—¶ä¸è¢«é®ä½ */
    .composer {
      padding-bottom: env(safe-area-inset-bottom);
    }


    html,
    body {
      height: 100dvh;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 14px/1.6 "Segoe UI", system-ui, -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif;
      overflow: hidden;
    }

    a {
      color: var(--gold1);
      text-decoration: none
    }

    /* é¡¶æ ï¼ˆè½»ç»ç’ƒ+å¾®å…‰ï¼‰ */
    header.nav {
      position: fixed;
      inset: 0 0 auto 0;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px 0 18px;
      z-index: 10;
      background: linear-gradient(180deg, rgba(0, 0, 0, .75), rgba(0, 0, 0, .25));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      box-shadow: 0 8px 24px rgba(0, 0, 0, .35), 0 0 16px var(--glow);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px
    }

    .brand .logo {
      width: 24px;
      height: 24px;
      background: url('assets/favicon.ico') center/cover no-repeat;
      border-radius: 4px;
      box-shadow: 0 0 8px rgba(230, 196, 122, .4)
    }

    .title {
      font-weight: 700;
      color: var(--gold2)
    }

    .right {
      display: flex;
      align-items: center;
      gap: 10px
    }

    /* â–¼ æŠŠå³ä¸Šè§’æŒ‰é’®æ”¹æˆâ€œä¸‹åˆ’çº¿â€é£æ ¼ï¼ˆä¸ ENTER ä¸€è‡´ï¼‰ */
    .btn {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      height: auto;
      padding: 0 0 2px;
      border: 0;
      background: transparent;
      border-radius: 0;
      color: var(--gold1);
    }

    .btn::after {
      content: "";
      position: absolute;
      left: 0;
      right: 0;
      bottom: -2px;
      height: 2px;
      background: linear-gradient(90deg, rgba(230, 196, 122, 0), rgba(230, 196, 122, .95), rgba(230, 196, 122, 0));
      transform: scaleX(0);
      transform-origin: left;
      transition: transform .26s ease;
    }

    .btn:hover::after {
      transform: scaleX(1);
    }

    /* å¸ƒå±€ï¼šå æ»¡è§†å£ï¼›å¤–å±‚ä¸æ»šåŠ¨ */
    .layout {
      position: absolute;
      inset: 0 0 0 0;
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 12px;
      padding: 12px;
      height: calc(100dvh - 64px);
      min-height: 0;
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, .35), 0 0 18px var(--glow);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      min-height: 0;
    }

    /* å·¦ä¾§æ‘˜è¦ï¼šè‡ªå·±æ»šåŠ¨ */
    .summary {
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      overflow: auto;
      min-height: 0;
    }

    .summary h2 {
      margin: 0 0 6px;
      font-size: 15px;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      user-select: none;
      /* è®©æ ‡é¢˜å§‹ç»ˆåœ¨æ‘˜è¦é¡¶éƒ¨ï¼ŒæŠ˜å /å±•å¼€æ›´å¥½ç‚¹ */
      position: sticky;
      top: 0;
      z-index: 1;
      padding: 6px 0;
      background: linear-gradient(180deg, rgba(0, 0, 0, .35), rgba(0, 0, 0, 0));
    }

    .summary h2::after {
      content: 'â–¾';
      /* å±•å¼€æ—¶çš„å°ç®­å¤´ */
      margin-left: 8px;
      color: var(--gold1);
      font-weight: 900;
    }

    .summary h2::before {
      content: "";
      display: inline-block;
      width: 6px;
      height: 16px;
      border-radius: 10px;
      background: linear-gradient(180deg, var(--gold1), rgba(208, 162, 74, .35));
      box-shadow: 0 0 12px rgba(208, 162, 74, .45)
    }

    /* æŠ˜å æ—¶ï¼šåªä¿ç•™æ ‡é¢˜ï¼Œéšè—å…¶å®ƒå†…å®¹ */
    .summary.collapsed> :not(h2) {
      display: none;
    }

    .summary.collapsed {
      overflow: visible;
    }

    /* æŠ˜å æ€ç®­å¤´æ”¹ä¸ºå‘å³ */
    .summary.collapsed h2::after {
      content: 'â–¸';
    }

    .kv {
      display: grid;
      grid-template-columns: 92px 1fr;
      gap: 6px;
      font-size: 13px;
      color: var(--muted)
    }

    .kv b {
      color: var(--text);
      font-weight: 600
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(208, 162, 74, .3);
      background: rgba(208, 162, 74, .12);
      color: #d9c18a;
      font-size: 12px
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .chip {
      cursor: pointer;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(208, 162, 74, .25);
      background: rgba(255, 255, 255, .04);
      color: #d9c18a;
      font-size: 12px;
      margin-bottom: 8px;
    }


    .shuo {
      color: #b17c00;
      font-size: 12px;
      position: relative;
      /* æˆ–è€…ç›´æ¥åˆ æ‰ position è¿™ä¸€è¡Œ */
      display: block;
      margin-top: 12px;
      /* å’Œä¸Šé¢çš„å¿«é€Ÿé—®é¢˜æ‹‰å¼€è·ç¦» */
      line-height: 1.4;
    }


    /* å³ä¾§èŠå¤©ï¼šå‘é€æ å›ºå®šåœ¨å¡ç‰‡åº•éƒ¨ */
    .chat {
      position: relative;
      display: grid;
      grid-template-rows: auto 1fr;
      height: 100%;
      min-height: 0;
      overflow: hidden;
    }

    .toolbar {
      display: grid;
      grid-template-columns: 140px 1fr 1fr 1fr;
      gap: 8px;
      padding: 10px;
      border-bottom: 1px solid var(--border);
      background: rgba(18, 18, 18, .40);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      box-shadow: inset 0 -1px 0 rgba(255, 255, 255, .05);
    }

    .toolbar select,
    .toolbar input {
      height: 34px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: rgba(0, 0, 0, 0.986);
      color: var(--text);
      padding: 0 10px
    }

    .messages {
      padding: 14px;
      padding-bottom: calc(var(--composer-h) + 18px);
      overflow: auto;
      min-height: 0;
    }

    .msg {
      display: flex;
      gap: 10px;
      margin: 10px 0
    }

    .msg .role {
      width: 58px;
      color: #c7a66a;
      flex-shrink: 0;
      font-size: 12px;
      text-align: right;
      padding-top: 4px
    }

    .bubble {
      flex: 1;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, .10);
      background: rgba(255, 255, 255, .04);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, .04), 0 0 14px rgba(208, 162, 74, .08);
    }

    .me .bubble {
      background: rgba(208, 162, 74, .1);
      border-color: rgba(208, 162, 74, .3)
    }

    /* â–¼ é»‘é‡‘é…è‰²ç”¨äºå›ç­”å†…å®¹ï¼›å¹¶ç§»é™¤åˆ†å‰²çº¿ */
    .bubble hr {
      display: none;
    }

    .bubble h1,
    .bubble h2,
    .bubble h3 {
      color: var(--gold2);
    }

    .bubble strong {
      color: var(--gold1);
    }

    .bubble blockquote {
      margin: .6em 0;
      padding: .35em .8em;
      border-left: 2px solid rgb(255, 185, 32);
      background: rgba(230, 196, 122, .06);
      border-radius: 8px;
    }

    .bubble ul,
    .bubble ol {
      padding-left: 1.25em
    }

    .bubble ul li::marker,
    .bubble ol li::marker {
      color: var(--gold1)
    }

    /* æµ®åŠ¨å‘é€æ¡†ï¼ˆæ‚¬æµ®ã€æ¯›ç»ç’ƒã€é‡‘è‰²å¾®å…‰ï¼‰ */
    .composer {
      position: absolute;
      left: 16px;
      right: 16px;
      bottom: 16px;
      z-index: 2;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border: 1px solid rgba(252, 184, 57, 0.671);
      background: rgba(20, 20, 20, .60);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border-radius: 14px;
      box-shadow: 0 8px 30px rgba(255, 153, 0, 0.486), 0 0 20px rgba(208, 162, 74, .18);
    }

    /* è¾“å…¥åŒºé€æ˜ï¼Œå’Œæµ®åŠ¨æ¡†ä¸€ä½“åŒ– */
    .composer textarea {
      flex: 1;
      min-height: 44px;
      padding: 10px 12px;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text);
      resize: vertical;
    }

    /* å‘é€æŒ‰é’®ç»´æŒé»‘é‡‘é£ */
    .composer button {
      height: 40px;
      padding: 0 16px;
      border-radius: 10px;
      border: 1px solid rgba(208, 162, 74, .45);
      background: linear-gradient(180deg, rgba(208, 162, 74, .22), rgba(208, 162, 74, .12));
      color: var(--text);
      box-shadow: 0 0 10px rgba(208, 162, 74, .15) inset;
    }


    /* å“åº”å¼ */
    @media (max-width:1024px) {
      .layout {
        grid-template-columns: 280px 1fr
      }
    }

    @media (max-width:860px) {
      .layout {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
        /* âœ… å…³é”®ä¿®å¤ï¼šè®©å¤–å±‚å¸ƒå±€åœ¨æ‰‹æœºç«¯å¯ä»¥çºµå‘æ»šåŠ¨ */
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }

      .toolbar {
        grid-template-columns: 1fr 1fr
      }
    }


    .toolbar {
      grid-template-columns: 1fr 1fr
    }


    @media (max-width:520px) {
      .toolbar {
        grid-template-columns: 1fr
      }
    }

    /* ç²’å­ç”»å¸ƒç½®é¡¶ï¼šä¸æ‹¦æˆªç‚¹å‡»ï¼Œä¸é®å†…å®¹ï¼ˆäº®åº¦å åŠ ï¼‰ */
    #fx-canvas {
      position: fixed;
      inset: 0;
      z-index: 99999;
      pointer-events: none;
      mix-blend-mode: screen;
      display: block;
    }

    header.nav,
    .layout {
      position: relative;
      z-index: 1
    }

    .nav-right-link {
      position: fixed;
      top: 18px;
      right: 24px;
      z-index: 1000;
      color: #ffffff;
      text-decoration: none;
      font-size: .95rem;
      letter-spacing: .15em;
      text-transform: uppercase;
      opacity: .92;
      padding-bottom: 4px;
      transition: opacity .25s ease, color .3s ease
    }

    .nav-right-link:hover {
      opacity: 1;
      color: #ffaa00
    }

    .nav-right-link::after {
      content: "";
      position: absolute;
      left: 0;
      bottom: 0;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, #ffcc66, #ff9900);
      transform: scaleX(0);
      transform-origin: right;
      transition: transform .35s ease;
      box-shadow: 0 0 12px rgba(255, 200, 100, .7)
    }

    .nav-right-link:hover::after {
      transform: scaleX(1);
      transform-origin: left
    }

    /* WebKit æ»šåŠ¨æ¡ï¼šé»‘é‡‘æ¸å˜ï¼ˆ#ffcc66 â†’ #ff9900ï¼‰ */
    .messages::-webkit-scrollbar,
    .summary::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    .messages::-webkit-scrollbar-track,
    .summary::-webkit-scrollbar-track {
      background: transparent;
    }

    .messages::-webkit-scrollbar-thumb,
    .summary::-webkit-scrollbar-thumb {
      border-radius: 999px;
      border: 2px solid rgba(0, 0, 0, .35);
      background: linear-gradient(180deg, #ffcc66cc, #916d21d8);
      box-shadow:
        0 0 10px rgba(255, 200, 100, .55) inset,
        0 0 8px rgba(255, 200, 100, .45);
      transition: background .25s ease, box-shadow .25s ease;
    }

    .messages::-webkit-scrollbar-thumb:hover,
    .summary::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #ffcc66cc, #916d21d8);
      box-shadow:
        0 0 12px rgba(255, 195, 83, 0.75) inset,
        0 0 10px rgba(255, 183, 50, 0.65);
    }

    /* Firefoxï¼ˆä¸æ”¯æŒæ¸å˜ï¼Œç”¨æ¥è¿‘è‰²ï¼‰ */
    .messages,
    .summary {
      scrollbar-width: thin;
      scrollbar-color: #ffcc66cc transparent;
    }

    /* ====== å·¦å³å¯¹è¯æ°”æ³¡ + å±…ä¸­å¸ƒå±€ï¼ˆä¸æ”¹ DOM/JSï¼‰====== */

    /* ç»Ÿä¸€å‚æ•° */
    :root {
      --chat-max: clamp(1000px, 90vw, 1200px);
      /* èŠå¤©åŒºæœ€å¤§å®½åº¦ï¼ˆæ¶ˆæ¯ + å‘é€æ¡†ï¼‰ */
      --role-w: 80px;
      /* å·¦ä¾§â€œè§’è‰²â€åˆ—å®½ */
      --gap: 10px;
      /* æ°”æ³¡ä¸è§’è‰²ä¹‹é—´çš„é—´è· */
    }

    /* æ¶ˆæ¯åˆ—è¡¨ä½œä¸ºçºµå‘å®¹å™¨ï¼Œå¹¶æ°´å¹³å±…ä¸­æ¯æ¡æ¶ˆæ¯ */
    .messages {
      display: flex;
      flex-direction: column;
      align-items: center;
      /* æ°´å¹³å±…ä¸­ .msg */
    }

    /* æ¯æ¡æ¶ˆæ¯ï¼šé™åˆ¶å®½åº¦ + ä½œä¸ºæ¨ªå‘å®¹å™¨ */
    .msg {
      width: min(100%, var(--chat-max));
      display: flex;
      align-items: flex-start;
      gap: var(--gap);
      margin: 10px 0;
    }

    /* è§’è‰²ååˆ—ï¼šå›ºå®šå®½åº¦ï¼Œä¸æ”¶ç¼©ï¼›å·¦å³å¯¹é½éšæ°”æ³¡æ–¹å‘å˜åŒ– */
    .msg .role {
      flex: 0 0 var(--role-w);
      width: var(--role-w);
      text-align: right;
      color: #c7a66a;
    }

    .msg.me .role {
      text-align: left;
    }

    /* æ°”æ³¡ï¼šå æ»¡å‰©ä½™å®½åº¦ï¼ˆå®¹å™¨ âˆ’ è§’è‰²åˆ— âˆ’ é—´è·ï¼‰ï¼Œå¹¶å…è®¸æ¢è¡Œ */
    .msg .bubble {
      flex: 1 1 auto;
      min-width: 0;
      /* é˜²æ­¢è¢«å­å…ƒç´ æ’‘ç ´ */
      max-width: calc(100% - var(--role-w) - var(--gap)) !important;
      position: relative;
      overflow-wrap: anywhere;
      word-break: break-word;
    }

    /* è‡ªå·±ï¼ˆæˆ‘ï¼‰åœ¨å³ä¾§ï¼šæ•´æ¡æ¶ˆæ¯é å³ï¼Œé¡ºåºåè½¬ï¼ˆå…ˆæ°”æ³¡åè§’è‰²ï¼‰ */
    .msg.me {
      justify-content: flex-end;
      flex-direction: row-reverse;
    }

    /* æˆ‘æ–¹æ°”æ³¡ï¼šé»‘é‡‘é«˜äº® */
    .msg.me .bubble {
      background: rgba(208, 162, 74, .10);
      border-color: rgba(208, 162, 74, .30);
      box-shadow: 0 0 14px rgba(208, 162, 74, .08), inset 0 0 0 1px rgba(255, 255, 255, .04);
    }

    /* å¯¹æ–¹ï¼ˆFEIï¼‰æ°”æ³¡ï¼šé»‘é‡‘ä½è°ƒ */
    .msg:not(.me) .bubble {
      background: rgba(255, 255, 255, .04);
      border-color: rgba(255, 255, 255, .10);
    }

    /* å‘é€æ ä¸æ¶ˆæ¯åŒå®½å¹¶æ°´å¹³å±…ä¸­ */
    .chat .composer {
      width: min(100%, var(--chat-max));
      left: 50%;
      right: auto;
      transform: translateX(-50%);
      box-sizing: border-box;
      /* é˜²æ­¢è¾¹æ¡†å¯¼è‡´æº¢å‡º */
    }

    /* çª„å±å æ»¡ï¼Œå¹¶é€‚åº¦æ”¶çª„è§’è‰²åˆ— */
    @media (max-width:860px) {
      :root {
        --chat-max: 100%;
        --role-w: 56px;
      }
    }

    /* å·¥å…·æ é‡Œçš„â€œå¯†ç  + çœ¼ç›â€å®¹å™¨ */
    .toolbar .field.password {
      position: relative;
      height: 34px;
    }

    .toolbar .field.password input {
      width: 100%;
      height: 34px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: rgba(0, 0, 0, .986);
      color: var(--text);
      padding: 0 36px 0 10px;
      /* å³ä¾§ç»™çœ¼ç›æŒ‰é’®ç•™ç©ºé—´ */
      box-sizing: border-box;
    }

    /* çœ¼ç›æŒ‰é’® */
    .toolbar .field.password .eye {
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      width: 26px;
      height: 26px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      border: 1px solid rgba(208, 162, 74, .35);
      background: linear-gradient(180deg, rgba(208, 162, 74, .22), rgba(208, 162, 74, .12));
      color: var(--text);
      cursor: pointer;
      opacity: .9;
    }

    .toolbar .field.password .eye:hover {
      opacity: 1;
      box-shadow: 0 0 8px var(--glow);
    }

    .small {
      font-size: 15px;
      color: var(--muted);
      opacity: 0.85;
      letter-spacing: 0.05em;
      line-height: 1.4;
      margin-bottom: 13px;
    }

    /* ===== æŠ˜å é¢æ¿ï¼ˆé»‘é‡‘é£æ ¼ï¼Œè´´åˆç°æœ‰ä¸»é¢˜å˜é‡ï¼‰ ===== */
    .collapsible {
      border: 1px solid var(--border, rgba(255, 255, 255, .12));
      background: var(--panel, rgba(18, 18, 18, .65));
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, .35), inset 0 0 0 1px rgba(255, 198, 76, .06);
      overflow: hidden;
      margin-bottom: 12px;
    }

    .collapsible .head {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      cursor: pointer;
      user-select: none;
      position: relative;
    }

    .collapsible .head .title {
      font-weight: 600;
      letter-spacing: .2px;
      filter: drop-shadow(0 0 6px rgba(214, 160, 60, .25));
    }

    .collapsible .head .summary {
      margin-left: auto;
      opacity: .7;
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 55%;
    }

    .collapsible .head .chev {
      width: 10px;
      height: 10px;
      margin-left: 8px;
      transition: transform .22s ease;
      border-right: 2px solid var(--gold1, #E6C47A);
      border-bottom: 2px solid var(--gold1, #E6C47A);
      transform: rotate(45deg);
    }

    .collapsible[data-collapsed="1"] .head .chev {
      transform: rotate(-135deg);
    }

    .collapsible .body {
      padding: 12px 14px 14px;
      border-top: 1px solid rgba(255, 198, 76, .12);
      background: linear-gradient(180deg, rgba(255, 198, 76, .06), transparent 30%);
    }

    .collapsible[data-collapsed="1"] .body {
      display: none;
    }
  </style>
</head>

<body>
  <canvas id="fx-canvas"></canvas>

  <header class="nav">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div class="title">Analyze your birth chartï¼ˆChatï¼‰</div>
    </div>
    <div class="right">
      <a class="nav-right-link" href="result.html">è¿”å›ç»“æœ</a>
    </div>
  </header>

  <main class="layout">
    <!-- å·¦ï¼šå‘½ç›˜æ‘˜è¦ -->
    <section class="card summary" id="summary">
      <h2>å‘½ç›˜æ‘˜è¦</h2>
      <div class="kv">
        <div>é˜³å†</div>
        <div><b id="sSolar">â€”</b></div>
      </div>
      <div class="kv">
        <div>å†œå†</div>
        <div><b id="sLunar">â€”</b></div>
      </div>
      <div class="kv">
        <div>å…«å­—</div>
        <div><b id="sEight">â€”</b></div>
      </div>
      <div class="kv">
        <div>åœ°ç‚¹</div>
        <div><span id="sLoc" class="small">â€”</span></div>
      </div>
      <div class="hr"></div>
      <div>
        <div class="small">äº”è¡Œåˆ†å¸ƒ</div>
        <div id="sWuxing" class="chips"></div>
      </div>
      <div>
        <div class="small">åç¥å æ¯”ï¼ˆTop3ï¼‰</div>
        <div id="sShishen" class="chips"></div>
      </div>
      <div class="hr"></div>
      <div>
        <div class="small">å¿«é€Ÿé—®é¢˜</div>
        <div class="chips" id="quick">
          <div class="chip" data-q="overall">æ€»ä½“æ ¼å±€è§£è¯»</div>
          <div class="chip" data-q="balance">äº”è¡Œå¼ºå¼±ä¸è°ƒå€™å»ºè®®</div>
          <div class="chip" data-q="ten">åç¥æ€§æ ¼ä¸ä¼˜åŠ¿çŸ­æ¿</div>
          <div class="chip" data-q="career">äº‹ä¸š/å­¦ä¸š/è´¢è¿</div>
          <div class="chip" data-q="love">æ„Ÿæƒ…/å©šå§»</div>
          <div class="chip" data-q="health">å¥åº·æ³¨æ„</div>
          <div class="chip" data-q="fortune">è¿‘ä¸‰å¹´æµå¹´çœ‹ç‚¹</div>
          <div class="chip" data-q="luck">å½“å‰å¤§è¿ä¸å»ºè®®</div>
        </div>
      </div>
      <div class="hr"></div>
      <div class="shuo">è¯´æ˜ï¼šAPIkey_VX:19002000113-é¡µé¢æ‰€æœ‰å†…å®¹ä»…ä¾›å¨±ä¹</div>
    </section>

    <!-- å³ï¼šèŠå¤©ä¸è®¾ç½®ï¼ˆä¿æŒåŸç»“æ„ä¸è„šæœ¬ï¼‰ -->
    <section class="card chat">
      <!-- æŠ˜å é¢æ¿ï¼šæ¨¡å‹ä¸å¯†é’¥ï¼ˆæŠŠåŸ toolbar åŒ…è¿›æ¥ï¼‰ -->
      <div id="modelPanel" class="collapsible" data-collapsed="0">
        <div class="head" id="modelPanelHead">
          <span class="title">Models & Keys</span>
          <small id="modelSummary" class="summary"></small>
          <i class="chev" aria-hidden="true"></i>
        </div>
        <div class="body" id="modelPanelBody">
          <!-- ä½ çš„åŸå§‹ toolbar ä¿æŒä¸å˜ï¼Œæ•´ä½“ç§»åˆ°è¿™é‡Œ -->
          <div class="toolbar">
            <select id="provider">
              <option value="openai">OpenAI</option>
              <option value="openrouter">OpenRouter</option>
              <option value="deepseek">DeepSeek</option>
              <option value="qwen">Qwen</option>
              <option value="proxy">è‡ªæœ‰ä»£ç†</option>
            </select>
            <select id="model"></select>
            <div class="field password">
              <input id="apiKey" type="password" autocomplete="off"
                placeholder="API Keyï¼ˆOpenAI/DeepSeek/OpenRouter/Qwen çš„ sk-...ï¼‰" />
              <button type="button" id="apiKeyToggle" class="eye" aria-label="æ˜¾ç¤º/éšè— API Key">ğŸ‘</button>
            </div>
            <input id="proxy" type="text" placeholder="é€‰â€œè‡ªæœ‰ä»£ç†â€æ—¶å¡«ï¼š/api/openai æˆ–å®Œæ•´ URL" />
          </div>
        </div>
      </div>

      <div id="messages" class="messages"></div>

      <div class="composer">
        <textarea id="input" placeholder="è¾“å…¥ä½ çš„é—®é¢˜ï¼Œæˆ–ç‚¹å‡»å·¦ä¾§å¿«æ·é—®é¢˜â€¦"></textarea>
        <button id="send">å‘é€</button>
      </div>
    </section>

  </main>

  <script>
    function pickFullText(json) {
      return (
        json?.choices?.[0]?.message?.content ||  // OpenAI/DeepSeek éæµå¼
        json?.choices?.[0]?.delta?.content ||  // ä¿é™©ï¼šæœ‰äº›ä¹Ÿä¼šç»™ delta
        json?.output_text ||  // ä¸€äº›å›½äº§/ä»£ç†å°è£…å­—æ®µ
        json?.data?.[0]?.content ||  // å¤‡é€‰
        ''
      );
    }
    /************** è¯»å– resultï¼ˆå…¼å®¹å¤šå­—æ®µåï¼‰ **************/
    function readBaziResult() {
      let raw = localStorage.getItem('baziResult') ?? sessionStorage.getItem('baziResult') ?? '';
      if (raw && typeof raw === 'string') { const i = raw.indexOf('{'); if (i > 0) raw = raw.slice(i); }
      let obj = {}; try { obj = raw ? JSON.parse(raw) : {} } catch (e) { console.warn('baziResult è§£æå¤±è´¥', e, raw) }
      const src = obj.data || obj.payload || obj.result || obj;
      const unify = (o) => {
        if (!o || typeof o !== 'object') return {}; return {
          ...o,
          meta: o.meta || {},
          wuXing: o.wuXing || o.wuxing || o.fiveElements || o['äº”è¡Œåˆ†å¸ƒ'] || null,
          shiShen: o.shiShen || o.shishen || o.tenGods || o['åç¥å æ¯”'] || null,
        }
      };  // ä¿ç•™ meta ä¾›æ‘˜è¦ä¼˜å…ˆè¯»å–
      return unify(src);
    }
    const state = { result: readBaziResult(), history: [] };

    /************** å·¦ä¾§æ‘˜è¦ï¼ˆä¿®å¤é˜³å†ï¼‰ **************/
    function renderSummary() {
      const r = state.result || {};
      const m = r.meta || {};

      const solar = m.solarDate || r.standardSolarDate || r.stdSolarDate || r.trueSolarDate || r.solarDate || '';
      const lunar = m.lunarDate || r.lunarDate || '';
      const ec = m.eightChar || r.eightChar || {};
      const birth = m.birthLocation || r.birthLocation || '';
      const curr = m.currentLocation || r.currentLocation || '';

      sSolar.textContent = solar || 'â€”';
      sLunar.textContent = lunar || 'â€”';
      sEight.textContent = [ec.year, ec.month, ec.day, ec.time].filter(Boolean).join(' ') || 'â€”';
      sLoc.textContent = [birth, curr].filter(Boolean).join(' Â· ') || 'â€”';

      sWuxing.innerHTML = '';
      if (r.wuXing) {
        Object.entries(r.wuXing).forEach(([k, v]) => {
          const el = document.createElement('div'); el.className = 'pill';
          const num = parseFloat(v); el.textContent = `${k} ${isFinite(num) ? num.toFixed(2) + '%' : String(v)}`;
          sWuxing.appendChild(el);
        });
      }

      sShishen.innerHTML = '';
      if (r.shiShen) {
        Object.entries(r.shiShen)
          .map(([k, v]) => [k, isFinite(+v) ? +v : parseFloat(String(v).replace('%', ''))])
          .filter(([, n]) => isFinite(n))
          .sort((a, b) => b[1] - a[1]).slice(0, 3)
          .forEach(([k, n]) => {
            const el = document.createElement('div'); el.className = 'pill'; el.textContent = `${k} ${n.toFixed(2)}%`; sShishen.appendChild(el);
          });
      }
    }
    renderSummary();


    /************** æç¤ºè¯æ¨¡æ¿ï¼ˆåŸæ ·ï¼‰ **************/
    function buildContextJSON(r) {
      const safe = {
        meta: { solarDate: (r.meta && r.meta.solarDate) || r.solarDate || '', lunarDate: (r.meta && r.meta.lunarDate) || r.lunarDate || '', eightChar: (r.meta && r.meta.eightChar) || r.eightChar || {}, birthLocation: (r.meta && r.meta.birthLocation) || r.birthLocation || '', currentLocation: (r.meta && r.meta.currentLocation) || r.currentLocation || '' },
        wuXing: r.wuXing || {}, shiShen: r.shiShen || {},
        geJu: r.geJu || '', zodiac: r.zodiac || '', naYin: r.naYin || {},
        daYun: Array.isArray(r.daYun) ? r.daYun.slice(0, 8) : [],
        liuNian: Array.isArray(r.liuNian) ? r.liuNian.slice(0, 12) : []
      };
      try { return JSON.stringify(safe); } catch { return '{}' }
    }
    // function buildSystemPrompt() {
    //   return [
    //     'ä½ æ˜¯ä¸€åæ‰åæ¨ªæº¢ã€å¦™è¶£æ¨ªç”Ÿçš„å…«å­—å‘½ç†åˆ†æå¸ˆï¼Œä¼¼æ˜Ÿè±¡ä¸­çš„è¯—è€…ï¼ŒåŸºäºæˆ‘æä¾›çš„ç»“æ„åŒ–æ•°æ®ï¼ˆè§â€œæ•°æ®â€JSONï¼‰ï¼Œä¸ºéä¸“ä¸šè¯»è€…ç»‡å°±ä¸€å¹…å¯è¡Œä¹‹é”¦ç»£å»ºè®®ï¼Œç‚¹äº®å…¶äººç”Ÿä¹‹è¯—ç¯‡ã€‚',
    //     'éµå¾ªä¹‹æ³•ï¼š',
    //     '- **Markdown** æ ¼å¼è¾“å‡ºï¼ŒäºŒçº§æ ‡é¢˜ï¼ˆ##ï¼‰é¢†è¡”ï¼Œé¡¹ç›®ç¬¦å·ç‚¹ç¼€ï¼›é¦–åˆ— 3~5 æ¡ã€å…³é”®ç»“è®ºã€‘ï¼Œå¦‚æ™¨æ˜ŸæŒ‡å¼•ã€‚',
    //     '- å”¯ä¾æ•°æ®æ¨æ¼”ï¼Œè‹¥æ•°æ®é˜™å¦‚ï¼Œé¡»æ˜è¨€å‡è®¾ï¼ˆå¦‚â€œå‡è®¾æ—¥ä¸»ä¸ºæŸäº”è¡Œâ€ï¼‰ï¼Œè°¨æ…é“ºé™ˆï¼Œä¼¼æ°´æµæ¸è¿›ã€‚',
    //     '- è¯­è°ƒæ¸©æ¶¦æœ‰è¶£ï¼Œé¿ç»å¯¹ä¹‹è¨€æˆ–æƒŠå¿ƒä¹‹è¯­ï¼Œç¦æ¶‰åŒ»ç–—ã€æ³•å¾‹ã€æŠ•èµ„ä¹‹è®ºï¼Œå”¯çŒ®ç”Ÿæ´»ä¹‹ç­–ã€‚',
    //     '- äº”è¡Œå¼ºå¼±ä¹‹åˆ¤ï¼š>35% ä¸ºå¼ºåŠ¿ï¼Œ<15% ä¸ºå¼±åŠ¿ï¼Œ0% ä¸ºç¼ºï¼›ç›¸ç”Ÿç›¸å…‹å¯è°ƒå’Œï¼Œä¼¼è‡ªç„¶ä¹‹éŸµã€‚',
    //     '- åç¥è§£è¯»ä»¥å æ¯” Top3 ä¸ºé‡ï¼Œæâ€œæ€§æ ¼ç‰¹è´¨ã€æ ¸å¿ƒèƒ½åŠ›ã€æ½œåœ¨é£é™©ã€æ”¹è¿›ä¹‹é“â€ï¼Œå¦‚ç”»å·ä¹‹ä¸‰æ‰ã€‚',
    //     '- è‹¥è®ºå¤§è¿/æµå¹´ï¼Œé¡»æ˜ç¤ºæ—¶çª—ï¼ˆå¦‚â€œ2025-2027â€ï¼‰ï¼Œèµ é’ˆå¯¹ä¹‹ç­–ï¼Œä¼¼æ—¶è¾°ä¹‹é’Ÿã€‚',
    //     '- è¯­è¨€ä¹‹é£ï¼šä¸“ä¸šè€Œä¸æ¯ç‡¥ï¼Œè¯—æ„è‹¥äº‘çƒŸï¼Œå–»å¦‚â€œå‘½ç›˜å¦‚å±±å·å¤§æ²³ï¼Œéœ€ä¿®ææŠ¤æµâ€ã€‚',
    //     'è¾“å‡ºä¹‹ç»“æ„ï¼š\n## å…³é”®ç»“è®º\n- ...\n## äº”è¡Œå¹³è¡¡ä¸è°ƒå€™\n...\n## åç¥æ´å¯Ÿ\n...\n## äº‹ä¸šä¸å­¦ä¸š\n...\n## æƒ…æ„Ÿä¸äººé™…\n...\n## å¥åº·ä¸ç”Ÿæ´»æ–¹å¼\n...\n## å¤§è¿ä¸æµå¹´è¶‹åŠ¿\n...\n## 30å¤©è¡ŒåŠ¨è®¡åˆ’\n- ...'
    //   ].join('\n');
    // }
    // function buildSystemPrompt() {
    //   return [
    //     'ä½ æ˜¯ä¸€åæ‰åæ¨ªæº¢ã€å¦™è¶£æ¨ªç”Ÿçš„å…«å­—å‘½ç†åˆ†æå¸ˆï¼Œä¼¼æ˜Ÿè±¡ä¸­çš„è¯—è€…ï¼ŒåŸºäºæˆ‘æä¾›çš„ç»“æ„åŒ–æ•°æ®ï¼ˆè§â€œæ•°æ®â€JSONï¼‰ï¼Œä¸ºéä¸“ä¸šè¯»è€…ç»‡å°±ä¸€å¹…å¯è¡Œä¹‹é”¦ç»£å»ºè®®ï¼Œç‚¹äº®å…¶äººç”Ÿä¹‹è¯—ç¯‡ã€‚',
    //     'éµå¾ªä¹‹æ³•ï¼š',
    //     '- **Markdown** æ ¼å¼è¾“å‡ºï¼ŒäºŒçº§æ ‡é¢˜ï¼ˆ##ï¼‰é¢†è¡”ï¼Œé¡¹ç›®ç¬¦å·ç‚¹ç¼€ï¼›é¦–åˆ— 3~5 æ¡ã€å…³é”®ç»“è®ºã€‘ï¼Œå¦‚æ™¨æ˜ŸæŒ‡å¼•ã€‚',
    //     '- å”¯ä¾æ•°æ®æ¨æ¼”ï¼Œè‹¥æ•°æ®é˜™å¦‚ï¼Œé¡»æ˜è¨€å‡è®¾ï¼ˆå¦‚â€œå‡è®¾æ—¥ä¸»ä¸ºæŸäº”è¡Œâ€ï¼‰ï¼Œè°¨æ…é“ºé™ˆï¼Œä¼¼æ°´æµæ¸è¿›ã€‚',
    //     '- è¯­è°ƒæ¸©æ¶¦æœ‰è¶£ï¼Œé¿ç»å¯¹ä¹‹è¨€æˆ–æƒŠå¿ƒä¹‹è¯­ï¼Œç¦æ¶‰åŒ»ç–—ã€æ³•å¾‹ã€æŠ•èµ„ä¹‹è®ºï¼Œå”¯çŒ®ç”Ÿæ´»ä¹‹ç­–ã€‚',
    //     '- äº”è¡Œå¼ºå¼±ä¹‹åˆ¤ï¼š>35% ä¸ºå¼ºåŠ¿ï¼Œ<15% ä¸ºå¼±åŠ¿ï¼Œ0% ä¸ºç¼ºï¼›ç›¸ç”Ÿç›¸å…‹å¯è°ƒå’Œï¼Œä¼¼è‡ªç„¶ä¹‹éŸµã€‚',
    //     '- åç¥è§£è¯»ä»¥å æ¯” Top3 ä¸ºé‡ï¼Œæâ€œæ€§æ ¼ç‰¹è´¨ã€æ ¸å¿ƒèƒ½åŠ›ã€æ½œåœ¨é£é™©ã€æ”¹è¿›ä¹‹é“â€ï¼Œå¦‚ç”»å·ä¹‹ä¸‰æ‰ã€‚',
    //     '- è‹¥è®ºå¤§è¿/æµå¹´ï¼Œé¡»æ˜ç¤ºæ—¶çª—ï¼ˆå¦‚â€œ2025-2027â€ï¼‰ï¼Œèµ é’ˆå¯¹ä¹‹ç­–ï¼Œä¼¼æ—¶è¾°ä¹‹é’Ÿã€‚',
    //     '- è¯­è¨€ä¹‹é£ï¼šä¸“ä¸šè€Œä¸æ¯ç‡¥ï¼Œè¯—æ„è‹¥äº‘çƒŸï¼Œå–»å¦‚â€œå‘½ç›˜å¦‚å±±å·å¤§æ²³ï¼Œéœ€ä¿®ææŠ¤æµâ€ã€‚',
    //     'è¾“å‡ºä¹‹ç»“æ„ï¼š\n## å…³é”®ç»“è®º\n- ...\n## äº”è¡Œå¹³è¡¡ä¸è°ƒå€™\n...\n## åç¥æ´å¯Ÿ\n...\n## äº‹ä¸šä¸å­¦ä¸š\n...\n## æƒ…æ„Ÿä¸äººé™…\n...\n## å¥åº·ä¸ç”Ÿæ´»æ–¹å¼\n...\n## å¤§è¿ä¸æµå¹´è¶‹åŠ¿\n...\n## 30å¤©è¡ŒåŠ¨è®¡åˆ’\n- ...'
    //   ].join('\n');
    // }

    /************** Markdown æ¸²æŸ“ï¼ˆæ”¯æŒæµå¼ï¼‰ **************/
    function escapeHtml(str) { return str.replace(/[&<>"']/g, s => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;" }[s])); }
    function miniMarkdown(md) {
      md = md.replace(/\r\n?/g, '\n');
      md = md.replace(/```([\s\S]*?)```/g, (m, code) => '<pre><code>' + escapeHtml(code) + '</code></pre>');
      md = md.replace(/^######\s+(.+)$/gm, '<h6>$1</h6>').replace(/^#####\s+(.+)$/gm, '<h5>$1</h5>')
        .replace(/^####\s+(.+)$/gm, '<h4>$1</h4>').replace(/^###\s+(.+)$/gm, '<h3>$1</h3>')
        .replace(/^##\s+(.+)$/gm, '<h2>$1</h2>').replace(/^#\s+(.+)$/gm, '<h1>$1</h1>');
      md = md.replace(/^>\s?(.+)$/gm, '<blockquote>$1</blockquote>');
      md = md.replace(/^(?:-\s.+\n?)+/gm, b => {
        const items = b.trim().split(/\n/).map(l => l.replace(/^[-*]\s+/, '')).map(escapeHtml).map(t => '<li>' + t + '</li>').join('');
        return '<ul>' + items + '</ul>';
      });
      md = md.replace(/^(?:\d+\.\s.+\n?)+/gm, b => {
        const items = b.trim().split(/\n/).map(l => l.replace(/^\d+\.\s+/, '')).map(escapeHtml).map(t => '<li>' + t + '</li>').join('');
        return '<ol>' + items + '</ol>';
      });
      md = md.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>').replace(/\*(.+?)\*/g, '<em>$1</em>').replace(/`([^`]+)`/g, '<code>$1</code>');
      md = md.replace(/^(?!<h\d|<ul>|<ol>|<pre>|<blockquote>)(.+)$/gm, (m, p) => '<p>' + p + '</p>');
      return md;
    }
    async function toHTML(md) {
      if (!window.marked) {
        try {
          await Promise.all([
            new Promise(r => { var s = document.createElement('script'); s.src = 'https://cdn.jsdelivr.net/npm/marked/marked.min.js'; s.onload = r; document.head.appendChild(s); }),
            new Promise(r => { var s = document.createElement('script'); s.src = 'https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js'; s.onload = r; document.head.appendChild(s); })
          ]);
        } catch (e) { }
      }
      if (window.marked && window.DOMPurify) { return window.DOMPurify.sanitize(window.marked.parse(md)); }
      return miniMarkdown(md);
    }

    var $msgs = document.getElementById('messages');
    function addMsg(role, text, isMd) {
      var row = document.createElement('div'); row.className = 'msg ' + (role === 'æˆ‘' ? 'me' : '');
      row.innerHTML = '<div class="role">' + role + '</div><div class="bubble"></div>';
      var bubble = row.querySelector('.bubble');
      if (isMd) { toHTML(text || '').then(html => { bubble.innerHTML = html; }); }
      else { bubble.textContent = text || ''; }
      $msgs.appendChild(row); $msgs.scrollTop = $msgs.scrollHeight; return bubble;
    }

    // å¿«æ·é—®é¢˜
    quick.addEventListener('click', function (e) {
      var chip = e.target.closest('.chip'); if (!chip) return;
      var kind = chip.getAttribute('data-q'); var prompt = (TEMPLATES[kind] || (() => ''))(state.result);
      input.value = prompt; send.click();
    });

    /************** Provider/Model ä¸‹æ‹‰ **************/
    var $provider = document.getElementById('provider');
    var $model = document.getElementById('model');
    var MODEL_OPTIONS = {
      openai: [
        { v: 'gpt-5', l: 'gpt-5ï¼ˆOpenAIï¼‰' },
        { v: 'gpt-5-mini', l: 'gpt-5-miniï¼ˆOpenAIï¼‰' },
        { v: 'gpt-4o', l: 'gpt-4oï¼ˆOpenAIï¼‰' },
        { v: 'gpt-4o-mini', l: 'gpt-4o-miniï¼ˆOpenAIï¼‰' }
      ],
      openrouter: [
        { v: 'openai/gpt-5', l: 'gpt-5ï¼ˆOpenRouterï¼‰' },
        { v: 'openai/gpt-4o', l: 'gpt-4oï¼ˆOpenRouterï¼‰' },
        { v: 'openai/gpt-4o-mini', l: 'gpt-4o-miniï¼ˆOpenRouterï¼‰' }
      ],
      deepseek: [
        { v: 'deepseek-chat', l: 'deepseek-chatï¼ˆé€šç”¨ï¼‰' },
        { v: 'deepseek-reasoner', l: 'deepseek-reasonerï¼ˆå¼ºæ¨ç†ï¼‰' }
      ],
      qwen: [
        { v: 'qwen-plus', l: 'qwen-plusï¼ˆQwenï¼‰' },
        { v: 'qwen-max', l: 'qwen-maxï¼ˆQwenï¼‰' },
        { v: 'qwen2.5-72b-instruct', l: 'qwen2.5-72b-instructï¼ˆQwenï¼‰' },
        { v: 'qwen2.5-32b-instruct', l: 'qwen2.5-32b-instructï¼ˆQwenï¼‰' },
        { v: 'qwen2.5-7b-instruct', l: 'qwen2.5-7b-instructï¼ˆQwenï¼‰' }
      ],
      proxy: [
        { v: 'gpt-5', l: 'è‡ªæœ‰ä»£ç†ï¼šgpt-5' },
        { v: 'gpt-4o', l: 'è‡ªæœ‰ä»£ç†ï¼šgpt-4o' }
      ]
    };
    function fillModels(provider) {
      $model.innerHTML = '';
      (MODEL_OPTIONS[provider] || MODEL_OPTIONS.openai).forEach(function (opt) {
        var o = document.createElement('option'); o.value = opt.v; o.textContent = opt.l; $model.appendChild(o);
      });
    }
    $provider.value = localStorage.getItem('FEI_PROVIDER') || 'qwen';
    fillModels($provider.value);
    $model.value = localStorage.getItem('FEI_MODEL') || $model.value;
    $provider.addEventListener('change', function () { fillModels($provider.value); localStorage.setItem('FEI_PROVIDER', $provider.value); localStorage.setItem('FEI_MODEL', $model.value); });
    $model.addEventListener('change', function () { localStorage.setItem('FEI_MODEL', $model.value); });

    /************** æ¢å¤ Key/ä»£ç†é…ç½® **************/
    apiKey.value = sessionStorage.getItem('FEI_API_KEY') || '';
    proxy.value = localStorage.getItem('FEI_PROXY') || '';
    apiKey.addEventListener('change', function () { sessionStorage.setItem('FEI_API_KEY', apiKey.value.trim()); });
    proxy.addEventListener('change', function () { localStorage.setItem('FEI_PROXY', proxy.value.trim()); });

    // çœ¼ç›å¼€å…³ï¼šæ˜¾ç¤º/éšè— API Key
    const $apiKeyToggle = document.getElementById('apiKeyToggle');
    if ($apiKeyToggle) {
      $apiKeyToggle.addEventListener('click', () => {
        const shown = apiKey.type === 'text';
        apiKey.type = shown ? 'password' : 'text';
        $apiKeyToggle.textContent = shown ? 'ğŸ‘' : 'ğŸ‘â€ğŸ—¨';
      });
    }
    function pickFullText(json) {
      return (
        json?.choices?.[0]?.message?.content ||
        json?.choices?.[0]?.delta?.content ||
        json?.output_text ||
        json?.data?.[0]?.content ||
        ''
      );
    }


    /************** å‘é€ **************/
    const DEMO_NO_BACKEND = true;
    send.addEventListener('click', async function () {
      if (DEMO_NO_BACKEND) {
        addMsg('FEI', 'Static demo: backend not deployed. Chat is disabled.', true);
        return;
      }
      var provider = $provider.value;
      var model = $model.value;

      var text = input.value.trim();
      if (!text) return;

      input.value = '';               // âœ… å‘é€åç«‹å³æ¸…ç©º
      input.style.height = '';        // å¯é€‰ï¼šå¦‚æœåšäº†è‡ªé€‚åº”é«˜åº¦ï¼Œé¡ºä¾¿è¿˜åŸ

      var key = apiKey.value.trim();
      var pxy = proxy.value.trim();

      addMsg('æˆ‘', text);
      var aiBubble = addMsg('FEI', '', true);
      var buf = '';
      var flush = function () { toHTML(buf).then(function (html) { aiBubble.innerHTML = html; $msgs.scrollTop = $msgs.scrollHeight; }); };
      var raf = null;
      var onToken = function (t) { buf += t; if (!raf) { raf = requestAnimationFrame(function () { flush(); raf = null; }); } };

      try {
        await streamChat({ provider: provider, model: model, apiKey: key, proxy: pxy, system: buildSystemPrompt(), user: text, onToken: onToken });
      } catch (err) { console.error(err); aiBubble.innerHTML = '<code>' + (err && err.message ? err.message : String(err)) + '</code>'; }
    });


    // ENTER å‘é€ï¼ˆShift+Enter æ¢è¡Œï¼›ä¸­æ–‡è¾“å…¥æ³•å€™é€‰æ—¶ä¸è§¦å‘ï¼‰
    const ta = document.getElementById('input');
    let composing = false;
    ta.addEventListener('compositionstart', () => composing = true);
    ta.addEventListener('compositionend', () => composing = false);

    ta.addEventListener('keydown', function (e) {
      if (e.isComposing || composing) return;        // æ­£åœ¨ä¸­æ–‡æ‹¼å†™
      if ((e.key === 'Enter' || e.keyCode === 13) && !e.shiftKey) {
        e.preventDefault();                           // é˜»æ­¢æ¢è¡Œ
        document.getElementById('send').click();      // è§¦å‘å‘é€
      }
    });




    /************** å„ Provider å®ç°ï¼ˆå« Qwenï¼‰ **************/
    async function streamChat(opts) {
      var provider = opts.provider, model = opts.model, apiKey = opts.apiKey, proxy = opts.proxy, system = opts.system, user = opts.user, onToken = opts.onToken;
      var messages = [{ role: 'system', content: system }, { role: 'user', content: user }];
      // â€”â€” å„ provider çš„éæµå¼å…œåº•è°ƒç”¨ï¼ˆå½“ res.body.getReader ä¸å¯ç”¨æ—¶ç”¨ï¼‰â€”â€”
      const nonStreamCallers = {
        openrouter: async () => {
          const r = await fetch('https://openrouter.ai/api/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + apiKey,
              'HTTP-Referer': location.origin.replace(/[^\x00-\x7F]/g, ''),
              'X-Title': 'FEI-Chat'
            },
            body: JSON.stringify({ model, messages, temperature: 0.7, stream: false })
          });
          const j = await r.json(); return pickFullText(j);
        },
        deepseek: async () => {
          const r = await fetch('https://api.deepseek.com/v1/chat/completions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + apiKey },
            body: JSON.stringify({ model, messages, temperature: 0.7, stream: false })
          });
          const j = await r.json(); return pickFullText(j);
        },
        openai: async () => {
          const r = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + apiKey },
            body: JSON.stringify({ model, messages, temperature: 0.7, stream: false })
          });
          const j = await r.json(); return pickFullText(j);
        },
        qwen: async () => {
          const r = await fetch('https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + apiKey },
            body: JSON.stringify({ model, messages, temperature: 0.7, stream: false })
          });
          const j = await r.json(); return pickFullText(j);
        },
        proxy: async () => {
          const r = await fetch(proxy, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ model, system, user, stream: false })
          });
          const j = await r.json(); return pickFullText(j);
        }
      };


      if (provider === 'openrouter') {
        if (!apiKey) throw new Error('ç¼ºå°‘ OpenRouter API Keyï¼ˆsk-or-v1-...ï¼‰');
        var res = await fetch('https://openrouter.ai/api/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'text/event-stream',
            'Authorization': 'Bearer ' + apiKey,
            'HTTP-Referer': location.origin.replace(/[^\x00-\x7F]/g, ''),
            'X-Title': 'FEI-Chat'
          },
          body: JSON.stringify({ model: model, messages: messages, temperature: 0.7, stream: true })
        });
        if (!res.ok) { var t1 = await res.text(); throw new Error('OpenRouter ' + res.status + ': ' + t1); }
        await readSSE(res, onToken, nonStreamCallers.openrouter); return;
      }

      if (provider === 'deepseek') {
        if (!apiKey) throw new Error('ç¼ºå°‘ DeepSeek API Keyï¼ˆsk-...ï¼‰');
        var res2 = await fetch('https://api.deepseek.com/v1/chat/completions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'text/event-stream', 'Authorization': 'Bearer ' + apiKey },
          body: JSON.stringify({ model: model, messages: messages, temperature: 0.7, stream: true })
        });
        if (!res2.ok) { var t2 = await res2.text(); throw new Error('DeepSeek ' + res2.status + ': ' + t2); }
        await readSSE(res2, onToken, nonStreamCallers.deepseek); return;
      }

      if (provider === 'openai') {
        if (!apiKey) throw new Error('ç¼ºå°‘ OpenAI API Keyï¼ˆsk-...ï¼‰');
        var res3 = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'text/event-stream', 'Authorization': 'Bearer ' + apiKey },
          body: JSON.stringify({ model: model, messages: messages, temperature: 0.7, stream: true })
        });
        if (!res3.ok) { var t3 = await res3.text(); throw new Error('OpenAI ' + res3.status + ': ' + t3); }
        await readSSE(res3, onToken, nonStreamCallers.openai); return;
      }

      /* âœ… Qwenï¼ˆDashScope å…¼å®¹æ¨¡å¼ï¼‰ */
      if (provider === 'qwen') {
        if (!apiKey) throw new Error('ç¼ºå°‘ Qwenï¼ˆDashScopeï¼‰API Key');
        const url = 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions';
        const resQ = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'text/event-stream', 'Authorization': 'Bearer ' + apiKey },
          body: JSON.stringify({ model: model, messages: messages, temperature: 0.7, stream: true })
        });
        if (!resQ.ok) { const t = await resQ.text(); throw new Error('Qwen ' + resQ.status + ': ' + t); }
        await readSSE(resQ, onToken, nonStreamCallers.qwen); return;
      }

      // è‡ªæœ‰ä»£ç†
      if (!proxy) throw new Error('è¯·é€‰æ‹©â€œè‡ªæœ‰ä»£ç†â€å¹¶å¡«å†™ä»£ç†åœ°å€');
      var res4 = await fetch(proxy, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ model: model, system: system, user: user, stream: true }) });
      if (!res4.ok) throw new Error('ä»£ç† ' + res4.status);
      await readSSE(res4, onToken, nonStreamCallers.proxy);
    }

    // é€šç”¨ SSE è¯»å–
    async function readSSE(res, onToken, fallbackNonStream) {
      // iOS Safari ç­‰ç¯å¢ƒï¼šres.body å¯èƒ½ä¸º nullï¼Œæ— æ³•æµå¼
      if (!res.body || !res.body.getReader) {
        if (typeof fallbackNonStream === 'function') {
          try {
            const txt = await fallbackNonStream();
            if (txt) onToken(txt);
          } catch (e) {
            console.error('non-stream fallback error:', e);
          }
        }
        return;
      }

      const reader = res.body.getReader();
      const decoder = new TextDecoder('utf-8');
      let buffer = '';

      while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, { stream: true });

        const parts = buffer.split('\n\n');
        buffer = parts.pop(); // ä¿ç•™æœªå®Œæ•´çš„ä¸€æ®µ

        for (let i = 0; i < parts.length; i++) {
          const line = parts[i].trim();
          if (!line) continue;
          const dataLine = line.startsWith('data:') ? line.slice(5).trim() : line;
          if (dataLine === '[DONE]') return;
          try {
            const json = JSON.parse(dataLine);
            const delta =
              json?.choices?.[0]?.delta?.content ||
              json?.choices?.[0]?.message?.content ||
              '';
            if (delta) onToken(delta);
          } catch (e) {
            // å•è¡Œ JSON è§£æå¤±è´¥å¿½ç•¥
          }
        }
      }
    }

    // åˆå§‹æ¬¢è¿
    (function () {
      addMsg('FEI', 'ä½ å¥½ï¼æˆ‘å·²è¯»å–ä½ çš„å‘½ç›˜æ•°æ®ï¼ˆè§å·¦ä¾§æ‘˜è¦ï¼‰ã€‚ä½ å¯ä»¥ç›´æ¥å‘é—®ï¼Œæˆ–ç‚¹å‡»å·¦ä¾§å¿«æ·é—®é¢˜ã€‚', true);
      input.value = TEMPLATES.overall(state.result);
    })();
  </script>
  <script>
    // â€”â€” æ‘˜è¦æŠ˜å /å±•å¼€ â€”â€” 
    (function () {
      const $sum = document.getElementById('summary');
      const $title = $sum && $sum.querySelector('h2');
      if (!$sum || !$title) return;

      // æ¢å¤ä¸Šæ¬¡çŠ¶æ€
      try {
        if (localStorage.getItem('FEI_SUMMARY_COLLAPSED') === '1') {
          $sum.classList.add('collapsed');
          $title.setAttribute('aria-expanded', 'false');
        } else {
          $title.setAttribute('aria-expanded', 'true');
        }
      } catch (e) { }

      // ç‚¹å‡»æ ‡é¢˜åˆ‡æ¢
      $title.addEventListener('click', () => {
        const collapsed = $sum.classList.toggle('collapsed');
        $title.setAttribute('aria-expanded', collapsed ? 'false' : 'true');
        try { localStorage.setItem('FEI_SUMMARY_COLLAPSED', collapsed ? '1' : '0'); } catch (e) { }
      });
    })();
  </script>


  <!-- è½»é‡é¼ æ ‡ç²’å­ï¼ˆç½®é¡¶ã€ä¸ä¼šé®æŒ¡å†…å®¹ï¼‰ -->
  <script>
    (function () {
      const cvs = document.getElementById('fx-canvas');
      const ctx = cvs.getContext('2d');
      let W = 0, H = 0, DPR = 1;
      function resize() {
        DPR = Math.max(1, devicePixelRatio || 1);
        W = innerWidth; H = innerHeight;
        cvs.width = W * DPR; cvs.height = H * DPR;
        cvs.style.width = W + 'px'; cvs.style.height = H + 'px';
        ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
      }
      addEventListener('resize', resize); resize();

      const COUNT = 120, SIZE = 3, SPEED = 0.5;
      const ps = Array.from({ length: COUNT }, () => ({ x: W / 2, y: H / 2, vx: (Math.random() - 0.5) * SPEED, vy: (Math.random() - 0.5) * SPEED }));

      let mx = W / 2, my = H / 2;
      addEventListener('mousemove', e => { mx = e.clientX; my = e.clientY; }, { passive: true });
      addEventListener('touchmove', e => { const t = e.touches[0]; if (t) { mx = t.clientX; my = t.clientY; } }, { passive: true });

      function step() {
        ctx.clearRect(0, 0, W, H);

        const g = ctx.createRadialGradient(mx, my, 0, mx, my, 150);
        g.addColorStop(0, 'rgba(230,196,122,.25)');
        g.addColorStop(1, 'rgba(230,196,122,0)');
        ctx.fillStyle = g;
        ctx.beginPath(); ctx.arc(mx, my, 240, 0, Math.PI * 2); ctx.fill();

        ctx.save();
        ctx.fillStyle = 'rgba(255,214,131,.20)';
        ps.forEach(p => {
          const ax = (mx - p.x) * 0.0006, ay = (my - p.y) * 0.0006;
          p.vx = (p.vx + ax) * 0.985;
          p.vy = (p.vy + ay) * 0.985;
          p.x += p.vx; p.y += p.vy;
          if (p.x < 0 || p.x > W) p.vx *= -1;
          if (p.y < 0 || p.y > H) p.vy *= -1;
          ctx.beginPath(); ctx.arc(p.x, p.y, SIZE, 0, Math.PI * 2); ctx.fill();
        });
        ctx.restore();

        requestAnimationFrame(step);
      }
      step();
    })();
  </script>

  <script>
    (function () {
      const comp = document.querySelector('.composer');
      const ta = document.getElementById('input');
      function setComposerH() {
        if (!comp) return;
        const h = comp.getBoundingClientRect().height;
        document.documentElement.style.setProperty('--composer-h', (h + 20) + 'px');
      }
      window.addEventListener('resize', setComposerH);
      if (ta) ta.addEventListener('input', setComposerH);
      setComposerH();
    })();
  </script>

  <script>
    (function () {
      const panel = document.getElementById('modelPanel');
      if (!panel) return;
      const head = document.getElementById('modelPanelHead');
      const summary = document.getElementById('modelSummary');

      // è®°ä½æŠ˜å çŠ¶æ€ï¼›ç§»åŠ¨ç«¯é»˜è®¤æŠ˜å ï¼Œæ¡Œé¢é»˜è®¤å±•å¼€
      const KEY = 'chat.modelPanel.collapsed';
      const saved = localStorage.getItem(KEY);
      const defaultCollapsed = window.innerWidth < 768 ? '1' : '0';
      panel.dataset.collapsed = (saved ?? defaultCollapsed);

      function setCollapsed(v) {
        panel.dataset.collapsed = v ? '1' : '0';
        localStorage.setItem(KEY, panel.dataset.collapsed);
      }
      head.addEventListener('click', () => {
        setCollapsed(panel.dataset.collapsed !== '1' ? 1 : 0);
      });

      // æ‘˜è¦ï¼ˆæä¾›å•† / æ¨¡å‹ / KEY æ˜¯å¦å¡«å†™ï¼‰
      function updateSummary() {
        const providerEl = document.querySelector('#provider');
        const modelEl = document.querySelector('#model');
        const keyEl = document.querySelector('#apiKey');
        const items = [];
        if (providerEl) {
          const txt = providerEl.options[providerEl.selectedIndex]?.text || providerEl.value || '';
          if (txt) items.push(txt);
        }
        if (modelEl) {
          const txt = modelEl.options[modelEl.selectedIndex]?.text || modelEl.value || '';
          if (txt) items.push(txt);
        }
        if (keyEl) { items.push(keyEl.value && keyEl.value.length > 6 ? 'â€¢KEY' : 'æœªå¡«KEY'); }
        summary.textContent = items.filter(Boolean).join(' Â· ');
      }
      updateSummary();
      document.addEventListener('change', (e) => {
        if (e.target && (e.target.id === 'provider' || e.target.id === 'model')) updateSummary();
      });
      document.addEventListener('input', (e) => {
        if (e.target && (e.target.id === 'apiKey')) updateSummary();
      });
    })();
  </script>

  <script>
    (function () {
      const meta = document.querySelector('meta[name=viewport]');
      if (!meta) return;

      const normalContent = 'width=device-width, initial-scale=1, viewport-fit=cover';
      const lockedContent = 'width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover';

      // è®°å½•æ»šåŠ¨ä½ç½®ï¼Œæ”¶èµ·é”®ç›˜åå›åˆ°åŸä½
      let lastScrollY = 0;

      function lockZoom() { meta.setAttribute('content', lockedContent); }
      function unlockZoom() { meta.setAttribute('content', normalContent); }

      // iOS èšç„¦æ—¶ï¼šä¸´æ—¶ç¦æ­¢ç¼©æ”¾ï¼Œé¿å…è‡ªåŠ¨æ”¾å¤§ï¼›è®°å½•æ»šåŠ¨
      document.addEventListener('focusin', (e) => {
        if (e.target.matches('input, textarea, select')) {
          lastScrollY = window.scrollY || document.documentElement.scrollTop || 0;
          lockZoom();
        }
      });

      // å¤±ç„¦æ—¶ï¼šæ¢å¤ç¼©æ”¾ï¼Œå¹¶æŠŠé¡µé¢æ»šå›åŸä½ç½®
      document.addEventListener('focusout', (e) => {
        if (e.target.matches('input, textarea, select')) {
          unlockZoom();
          // ç­‰é”®ç›˜å®Œå…¨æ”¶èµ·å†æ»šå›ï¼ŒiOS éœ€è¦ä¸€ç‚¹å»¶æ—¶
          setTimeout(() => { window.scrollTo(0, lastScrollY); }, 50);
        }
      });

      // é¢å¤–ï¼šé˜»æ­¢åŒå‡»æ”¾å¤§ï¼ˆå¯é€‰ï¼‰
      let lastTouch = 0;
      document.addEventListener('touchend', (e) => {
        const now = Date.now();
        if (now - lastTouch < 300) e.preventDefault();
        lastTouch = now;
      }, { passive: false });
    })();
  </script>
  <script>
    /* ========= åˆå‚æ¥æ”¶ & æç¤ºè¯è¦†ç›–ï¼ˆæ–°å¢ï¼Œä¸æ”¹ä½ åŸä»£ç ï¼‰ ========= */
    (function () {
      // ä¸å„é¡µä¿æŒä¸€è‡´çš„ key / é¢‘é“å
      const BAZI_RESULT_KEY = 'bazi:lastResult:v1';
      const LIUYAO_RESULT_KEY = 'bazi:liuyao:v1';
      const CHANNEL_NAME = 'bazi-channel';

      // å†…éƒ¨æš‚å­˜
      const store = { bazi: null, liuyao: null };

      // â€”â€” å‘½ç›˜æ•°æ®é€‚é…ï¼šè½¬æˆä½ å·¦ä¾§æ‘˜è¦ä½¿ç”¨çš„ç»“æ„ï¼ˆstate.result å…¼å®¹ï¼‰
      function adaptBaziToState(bz) {
        if (!bz || !bz.meta) return null;
        return {
          meta: {
            solarDate: bz.meta.solarDate || '',
            lunarDate: bz.meta.lunarDate || '',
            eightChar: bz.meta.eightChar || {},
            birthLocation: bz.meta.birthLocation || '',
            currentLocation: bz.meta.currentLocation || ''
          },
          wuXing: bz.wuXing || {},
          shiShen: bz.shiShen || {},
          geJu: bz.geJu || '',
          zodiac: bz.zodiac || '',
          naYin: bz.naYin || {},
          daYun: Array.isArray(bz.daYun) ? bz.daYun : [],
          liuNian: Array.isArray(bz.liuNian) ? bz.liuNian : []
        };
      }

      // â€”â€” åˆå§‹åŒ–ï¼šä» localStorage è¯»ä¸€é
      function initRead() {
        try {
          const rawBz = JSON.parse(localStorage.getItem(BAZI_RESULT_KEY) || 'null');
          if (rawBz) {
            store.bazi = rawBz;
            // åˆ·æ–°å·¦ä¾§æ‘˜è¦ï¼šæŠŠ state.result æ›¿æ¢ä¸ºæ–°å‘½ç›˜ï¼Œå¹¶é‡æ¸²æŸ“
            if (window.state) {
              const adapted = adaptBaziToState(rawBz);
              if (adapted) { window.state.result = adapted; if (typeof renderSummary === 'function') renderSummary(); }
            }
          }
        } catch { }

        try {
          const rawLy = JSON.parse(localStorage.getItem(LIUYAO_RESULT_KEY) || 'null');
          if (rawLy) store.liuyao = rawLy;
        } catch { }

        renderIncomingBadges();
      }

      // â€”â€” ç›‘å¬å¹¿æ’­ï¼šå®æ—¶æ¥æ”¶å‘½ç›˜/å…­çˆ»
      try {
        const bc = new BroadcastChannel(CHANNEL_NAME);
        bc.onmessage = (e) => {
          const { type, payload } = e.data || {};
          if (type === 'bazi_result_updated') {
            store.bazi = payload;
            localStorage.setItem(BAZI_RESULT_KEY, JSON.stringify(payload));
            if (window.state) {
              const adapted = adaptBaziToState(payload);
              if (adapted) { window.state.result = adapted; if (typeof renderSummary === 'function') renderSummary(); }
            }
          }
          if (type === 'liuyao_result_updated') {
            store.liuyao = payload;
            localStorage.setItem(LIUYAO_RESULT_KEY, JSON.stringify(payload));
          }
          renderIncomingBadges();
        };
      } catch { }

      // â€”â€” UIï¼šè¾“å…¥æ¡†ä¸Šæ–¹æ˜¾ç¤ºå¾½æ ‡
      function renderIncomingBadges() {
        const host = document.getElementById('incomingTips') || (() => {
          const n = document.createElement('div');
          n.id = 'incomingTips';
          n.style.cssText = 'margin:8px 0 4px; display:flex; gap:8px; flex-wrap:wrap;';
          const composer = document.querySelector('.composer');
          composer?.parentNode?.insertBefore(n, composer);
          return n;
        })();
        host.innerHTML = '';
        if (store.bazi) { const s = document.createElement('span'); s.className = 'chip chip-ok'; s.textContent = 'å·²æ¥æ”¶ï¼šå‘½ç›˜'; host.appendChild(s); }
        if (store.liuyao) { const s = document.createElement('span'); s.className = 'chip chip-ok'; s.textContent = 'å·²æ¥æ”¶ï¼šå…­çˆ»'; host.appendChild(s); }
      }
      // å¾½æ ‡æ ·å¼ï¼ˆä¸ç°æœ‰é»‘é‡‘é£æ ¼ä¸€è‡´ï¼‰
      (function () {
        const style = document.createElement('style');
        style.textContent = '.chip{padding:4px 8px;border-radius:999px;border:1px solid rgba(255,198,76,.25);font-size:12px;opacity:.9}.chip-ok{background:rgba(255,198,76,.08)}';
        document.head.appendChild(style);
      })();

      // â€”â€” å®‰å…¨æ‰“åŒ…å‘½ç›˜ JSONï¼ˆä¿ç•™ä½ ç³»ç»Ÿæç¤ºé‡Œè¦ç”¨çš„â€œæ•°æ®(JSON)â€ï¼‰
      function packBaziJSON() {
        try {
          if (!window.state || !state.result) return '{}';
          const r = state.result;
          const safe = {
            meta: {
              solarDate: r.meta?.solarDate || '',
              lunarDate: r.meta?.lunarDate || '',
              eightChar: r.meta?.eightChar || {},
              birthLocation: r.meta?.birthLocation || '',
              currentLocation: r.meta?.currentLocation || ''
            },
            wuXing: r.wuXing || {},
            shiShen: r.shiShen || {},
            geJu: r.geJu || '',
            zodiac: r.zodiac || '',
            naYin: r.naYin || {},
            daYun: Array.isArray(r.daYun) ? r.daYun.slice(0, 8) : [],
            liuNian: Array.isArray(r.liuNian) ? r.liuNian.slice(0, 12) : []
          };
          return JSON.stringify(safe);
        } catch { return '{}'; }
      }

      // â€”â€” æŠŠå…­çˆ»è½¬æˆç®€æ´æ‘˜è¦ï¼ˆä¾›ç³»ç»Ÿæç¤ºè¯æ‹¼æ¥ï¼‰
      function packLiuyaoText() {
        const ly = store.liuyao || null;
        if (!ly) return 'ï¼ˆæœªæ¥æ”¶å…­çˆ»æ•°æ®ï¼‰';
        const arr = [];
        arr.push(`ä¸»é¢˜ï¼š${ly.question || ''}ï½œæ—¶é—´ï¼š${ly.time || ''}`);
        arr.push(`æœ¬å¦ / å˜å¦ï¼š${ly.æœ¬å¦ || ''}${ly.å˜å¦ ? ' â†’ ' + ly.å˜å¦ : ''}`);
        arr.push(`ç”¨ç¥ï¼š${ly.ç”¨ç¥ || 'è‡ªåŠ¨'}ï½œæµæ´¾ï¼š${ly.æµæ´¾ || ''}`);
        if (ly.ä¸–åº”) arr.push(`ä¸–åº”ï¼š${ly.ä¸–åº”}`);
        if (Array.isArray(ly.åŠ¨çˆ») && ly.åŠ¨çˆ».length) arr.push(`åŠ¨çˆ»ï¼š${ly.åŠ¨çˆ».join('ã€')}`);
        if (ly.å…­äº²å¼ºå¼± && typeof ly.å…­äº²å¼ºå¼± === 'object') {
          const kins = Object.entries(ly.å…­äº²å¼ºå¼±).map(([k, v]) => `${k}${v}`).join('ã€');
          if (kins) arr.push(`å…­äº²å¼ºå¼±ï¼š${kins}`);
        }
        if (Array.isArray(ly.ç¥ç…) && ly.ç¥ç….length) arr.push(`ç¥ç…ï¼š${ly.ç¥ç….join('ã€')}`);
        return arr.join('\n- ');
      }

      // â€”â€” è¦†ç›– buildSystemPromptï¼ˆä¿æŒä½ çš„åŸé£æ ¼è¦æ±‚ + è‡ªåŠ¨å¸¦å…¥å‘½ç›˜/å…­çˆ»ï¼‰
      window.buildSystemPrompt = function () {
        // ä½ çš„åŸâ€œé£æ ¼è§„èŒƒâ€æ®µè½ï¼ˆä¿æŒä¸å˜ï¼‰
        const stylePart = [
          'ä½ æ˜¯ä¸€åæ‰åæ¨ªæº¢ã€å¦™è¶£æ¨ªç”Ÿçš„å…«å­—å‘½ç†åˆ†æå¸ˆï¼Œä¼¼æ˜Ÿè±¡ä¸­çš„è¯—è€…ï¼ŒåŸºäºæˆ‘æä¾›çš„ç»“æ„åŒ–æ•°æ®ï¼ˆè§â€œæ•°æ®â€JSONï¼‰ï¼Œä¸ºéä¸“ä¸šè¯»è€…ç»‡å°±ä¸€å¹…å¯è¡Œä¹‹é”¦ç»£å»ºè®®ï¼Œç‚¹äº®å…¶äººç”Ÿä¹‹è¯—ç¯‡ã€‚',
          'éµå¾ªä¹‹æ³•ï¼š',
          '- **Markdown** æ ¼å¼è¾“å‡ºï¼ŒäºŒçº§æ ‡é¢˜ï¼ˆ##ï¼‰é¢†è¡”ï¼Œé¡¹ç›®ç¬¦å·ç‚¹ç¼€ï¼›é¦–åˆ— 3~5 æ¡ã€å…³é”®ç»“è®ºã€‘ï¼Œå¦‚æ™¨æ˜ŸæŒ‡å¼•ã€‚',
          '- å”¯ä¾æ•°æ®æ¨æ¼”ï¼Œè‹¥æ•°æ®é˜™å¦‚ï¼Œé¡»æ˜è¨€å‡è®¾ï¼ˆå¦‚â€œå‡è®¾æ—¥ä¸»ä¸ºæŸäº”è¡Œâ€ï¼‰ï¼Œè°¨æ…é“ºé™ˆï¼Œä¼¼æ°´æµæ¸è¿›ã€‚',
          '- è¯­è°ƒæ¸©æ¶¦æœ‰è¶£ï¼Œé¿ç»å¯¹ä¹‹è¨€æˆ–æƒŠå¿ƒä¹‹è¯­ï¼Œç¦æ¶‰åŒ»ç–—ã€æ³•å¾‹ã€æŠ•èµ„ä¹‹è®ºï¼Œå”¯çŒ®ç”Ÿæ´»ä¹‹ç­–ã€‚',
          '- äº”è¡Œå¼ºå¼±ä¹‹åˆ¤ï¼š>35% ä¸ºå¼ºåŠ¿ï¼Œ<15% ä¸ºå¼±åŠ¿ï¼Œ0% ä¸ºç¼ºï¼›ç›¸ç”Ÿç›¸å…‹å¯è°ƒå’Œï¼Œä¼¼è‡ªç„¶ä¹‹éŸµã€‚',
          '- åç¥è§£è¯»ä»¥å æ¯” Top3 ä¸ºé‡ï¼Œæâ€œæ€§æ ¼ç‰¹è´¨ã€æ ¸å¿ƒèƒ½åŠ›ã€æ½œåœ¨é£é™©ã€æ”¹è¿›ä¹‹é“â€ï¼Œå¦‚ç”»å·ä¹‹ä¸‰æ‰ã€‚',
          '- è‹¥è®ºå¤§è¿/æµå¹´ï¼Œé¡»æ˜ç¤ºæ—¶çª—ï¼ˆå¦‚â€œ2025-2027â€ï¼‰ï¼Œèµ é’ˆå¯¹ä¹‹ç­–ï¼Œä¼¼æ—¶è¾°ä¹‹é’Ÿã€‚',
          '- è¯­è¨€ä¹‹é£ï¼šä¸“ä¸šè€Œä¸æ¯ç‡¥ï¼Œè¯—æ„è‹¥äº‘çƒŸï¼Œå–»å¦‚â€œå‘½ç›˜å¦‚å±±å·å¤§æ²³ï¼Œéœ€ä¿®ææŠ¤æµâ€ã€‚',
          'è¾“å‡ºä¹‹ç»“æ„ï¼š\n## å…³é”®ç»“è®º\n- ...\n## äº”è¡Œå¹³è¡¡ä¸è°ƒå€™\n...\n## åç¥æ´å¯Ÿ\n...\n## äº‹ä¸šä¸å­¦ä¸š\n...\n## æƒ…æ„Ÿä¸äººé™…\n...\n## å¥åº·ä¸ç”Ÿæ´»æ–¹å¼\n...\n## å¤§è¿ä¸æµå¹´è¶‹åŠ¿\n...\n## 30å¤©è¡ŒåŠ¨è®¡åˆ’\n- ...'
        ].join('\n');

        // è‡ªåŠ¨æ‹¼å…¥å‘½ç›˜ JSON & å…­çˆ»æ‘˜è¦ï¼ˆåˆå‚ï¼‰
        const baziJSON = packBaziJSON();
        const liuyaoTxt = packLiuyaoText();

        return [
          stylePart,
          '\nâ€”â€”\nã€æ•°æ®(JSON)ã€‘\n' + baziJSON,
          '\nã€å…­çˆ»æ‘˜è¦ã€‘\n- ' + liuyaoTxt,
          '\nè¯·å…ˆåŸºäºå…­çˆ»ä½œå‡ºç»“è®ºï¼Œå†ç”¨å‘½ç›˜æ ¡æ­£ä¸è¡¥å……ï¼›è‹¥ä»»ä¸€æ•°æ®ç¼ºå¤±ï¼Œè¯·è¯´æ˜å¹¶ç»§ç»­å›ç­”ã€‚'
        ].join('\n');
      };

      // é¦–æ¬¡è½½å…¥æ—¶è¯»å–ä¸€æ¬¡ï¼ˆå…œåº•ï¼‰
      initRead();
    })();
  </script>



</body>

</html>
