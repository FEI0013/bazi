<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AIRA</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box
    }

    /* 页面背景统一为 bg-home.jpg */
    html,
    body {
      width: 100%;
      height: 100%;
      background: url('./assets/image/bg-home.jpg') center/cover no-repeat fixed;
      color: #fff;
      font-family: "Segoe UI", system-ui, -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif;
    }

    #bgCanvas {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    .loading-screen {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2;
    }

    .form-bar {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -20%);
      display: flex;
      gap: 8px;
      flex-wrap: nowrap;
      overflow-x: auto;
      overflow-y: hidden;
      white-space: nowrap;
      -webkit-overflow-scrolling: touch;
      max-width: 92vw;
      background: rgba(255, 255, 255, .1);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, .3);
      border-radius: 8px;
      padding: 12px;
      z-index: 3;
    }

    /* 横向滚动条整体高度更小，贴近“下划线”效果 */
    .form-bar::-webkit-scrollbar {
      height: 4px;
      /* 比原来的 8px 更细，更像下划线 */
    }

    /* 滚动条轨道（背景透明，不显示） */
    .form-bar::-webkit-scrollbar-track {
      background: transparent;
    }

    /* 滚动条滑块（左到右渐变发光线） */
    .form-bar::-webkit-scrollbar-thumb {
      background: linear-gradient(90deg, #ffcc66, #ff9900);
      border-radius: 2px;
      box-shadow: 0 0 6px rgba(255, 200, 100, 0.6);
    }


    .form-bar>* {
      flex: 0 0 auto;
      min-width: 80px
    }

    /* 原生 select（自定义下拉会隐藏它们） */
    .form-bar select {
      padding: 8px 28px 8px 10px;
      border-radius: 4px;
      font-size: .9rem;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      color: #fff2c9;
      border: 1px solid rgba(255, 210, 130, .65);
      background:
        radial-gradient(120% 90% at 50% -35%, rgba(255, 233, 173, .45) 0%, rgba(255, 233, 173, 0) 60%),
        linear-gradient(180deg, rgba(40, 32, 24, .38) 0%, rgba(22, 18, 14, .38) 100%),
        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23ffda85'><path d='M4 6l4 4 4-4'/></svg>") right 10px center/12px 12px no-repeat;
      backdrop-filter: blur(8px) saturate(120%);
      -webkit-backdrop-filter: blur(8px) saturate(120%);
      text-shadow: 0 0 3px rgba(255, 223, 160, .25);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, .28), inset 0 -1px 0 rgba(0, 0, 0, .25), 0 0 10px rgba(255, 214, 131, .22);
      transition: border-color .2s, box-shadow .25s, filter .2s;
    }

    .form-bar select:hover {
      border-color: rgba(255, 214, 131, .9);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, .35), 0 0 14px rgba(255, 214, 131, .35);
      filter: brightness(1.05) saturate(1.06)
    }

    .form-bar select:focus {
      outline: none;
      border-color: rgba(255, 214, 131, 1);
      box-shadow: 0 0 0 3px rgba(255, 214, 131, .25), 0 0 22px rgba(255, 214, 131, .5), inset 0 1px 0 rgba(255, 255, 255, .35);
      filter: brightness(1.06) saturate(1.08)
    }

    .form-bar select option {
      background-color: rgba(27, 22, 16, .72) !important;
      color: #ffe9ba
    }

    .form-bar select option:checked {
      background-color: rgba(255, 214, 131, .22) !important;
      color: #fffdf4
    }

    .submit-container {
      position: absolute;
      top: 75%;
      left: 50%;
      transform: translate(-50%, 10px);
      z-index: 3
    }

    .submit-container button {
      background: transparent;
      border: none;
      color: #fff;
      font-size: 1.2rem;
      letter-spacing: 0.15em;
      cursor: pointer;
      position: relative;
      text-transform: uppercase;
      padding: 8px 12px;
      transition: color .3s ease;
    }

    /* 下划线发光特效 */
    .submit-container button::after {
      content: "";
      position: absolute;
      left: 0;
      bottom: 0;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, #ffcc66, #ff9900);
      transform: scaleX(0);
      transform-origin: right;
      transition: transform .35s ease;
      box-shadow: 0 0 12px rgba(255, 200, 100, 0.7);
    }

    .submit-container button:hover {
      color: #ffd580;
    }

    .submit-container button:hover::after {
      transform: scaleX(1);
      transform-origin: left;
    }




    
    .demo-note {
      margin-top: 10px;
      text-align: center;
      color: rgba(255, 214, 131, 0.85);
      font-size: 12px;
      letter-spacing: 0.08em;
    }
/* 左上角 Logo 统一样式 */
    .nav-left {
      position: fixed;
      top: 18px;
      left: 24px;
      z-index: 3;
      display: flex;
      align-items: center;
    }

    .nav-left .nav-logo img {
      width: 28px;
      height: 28px;
      display: block;
    }

    /* ============ 自定义下拉（黑金滚动条） ============ */
    .gx-wrap {
      position: relative;
      min-width: 80px;
      display: block
    }

    .gx-btn {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      padding: 8px 28px 8px 10px;
      border-radius: 4px;
      font-size: .9rem;
      color: #fff2c9;
      border: 1px solid rgba(255, 210, 130, .65);
      background:
        radial-gradient(120% 90% at 50% -35%, rgba(255, 233, 173, .45) 0%, rgba(255, 233, 173, 0) 60%),
        linear-gradient(180deg, rgba(40, 32, 24, .38) 0%, rgba(22, 18, 14, .38) 100%);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, .28), inset 0 -1px 0 rgba(0, 0, 0, .25), 0 0 10px rgba(255, 214, 131, .22);
    }

    .gx-btn:after {
      content: "";
      width: 12px;
      height: 12px;
      margin-left: 8px;
      background: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23ffda85'><path d='M4 6l4 4 4-4'/></svg>") center/12px 12px no-repeat
    }

    .gx-list {
      position: fixed;
      max-height: 260px;
      overflow: auto;
      z-index: 99999;
      border-radius: 8px;
      border: 1px solid rgba(255, 210, 130, .35);
      background: rgba(27, 22, 16, .92);
      box-shadow: 0 8px 24px rgba(0, 0, 0, .5), 0 0 18px rgba(255, 214, 131, .15);
      display: none;
      scrollbar-width: thin;
      scrollbar-color: #d9a944 #1a140d;
    }

    .gx-item {
      padding: 8px 10px;
      color: #ffe9ba;
      cursor: pointer;
      user-select: none
    }

    .gx-item:hover {
      background: rgba(255, 214, 131, .18);
      color: #fffdf4
    }

    .gx-item.active {
      background: rgba(255, 214, 131, .28);
      color: #fffdf4
    }

    .gx-list::-webkit-scrollbar {
      width: 10px
    }

    .gx-list::-webkit-scrollbar-track {
      background: linear-gradient(180deg, #1a140d, #2a2218);
      border-radius: 8px;
      box-shadow: inset 0 0 6px rgba(0, 0, 0, .5)
    }

    .gx-list::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #caa44f, #f7d88a);
      border-radius: 8px;
      border: 1px solid rgba(255, 220, 150, .4);
      box-shadow: inset 0 0 6px rgba(0, 0, 0, .3), 0 0 6px rgba(255, 214, 131, .35)
    }

    .gx-list::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #e3b74f, #ffe299)
    }
  </style>
</head>

<body>
  <canvas id="bgCanvas"></canvas>

  <div class="loading-screen">

    <!-- 左上角统一图标 -->
    <div class="nav-left">
      <a href="#" class="nav-logo" aria-label="Home">
        <img src="assets/favicon.ico" alt="Logo">
      </a>
    </div>

    <div class="form-bar" id="detail-form">
      <select id="birthYear" name="year">
        <option disabled selected>年</option>
      </select>
      <select id="birthMonth" name="month">
        <option disabled selected>月</option>
      </select>
      <select id="birthDay" name="day">
        <option disabled selected>日</option>
      </select>
      <select id="birthHour" name="hour">
        <option disabled selected>时</option>
      </select>
      <select id="birthMinute" name="minute">
        <option disabled selected>分</option>
      </select>
      <select id="gender" name="gender">
        <option disabled selected>性别</option>
        <option value="1">1</option>
        <option value="0">0</option>
      </select>
      <select id="birthProvince" name="birthProvince">
        <option disabled selected>出生省</option>
      </select>
      <select id="birthCity" name="birthCity" style="display:none;">
        <option disabled selected>市</option>
      </select>
      <select id="birthDistrict" name="birthDistrict" style="display:none;">
        <option disabled selected>区</option>
      </select>
      <select id="currentProvince" name="currentProvince">
        <option disabled selected>现居省</option>
      </select>
      <select id="currentCity" name="currentCity" style="display:none;">
        <option disabled selected>市</option>
      </select>
      <select id="currentDistrict" name="currentDistrict" style="display:none;">
        <option disabled selected>区</option>
      </select>
    </div>

    <div class="submit-container">
      <button id="submitBtn">submit</button>
      <div class="demo-note">??????????????</div>
    </div>
  </div>

  <script>
    /* ========= 填充时间 ========= */
    function populateTime() {
      const now = new Date(), cy = now.getFullYear();
      const Y = birthYear, M = birthMonth, D = birthDay;
      for (let y = cy; y >= 1900; y--) Y.add(new Option(y, y));
      for (let m = 1; m <= 12; m++) { const v = String(m).padStart(2, '0'); M.add(new Option(m, v)); }
      function updD() { const y = +Y.value || cy, m = +M.value || 1, ld = new Date(y, m, 0).getDate(); D.length = 1; for (let d = 1; d <= ld; d++) { const v = String(d).padStart(2, '0'); D.add(new Option(d, v)); } rebuildFancy([D]); }
      Y.onchange = updD; M.onchange = updD; updD();
      const H = birthHour, Min = birthMinute;
      for (let h = 0; h < 24; h++) { const v = String(h).padStart(2, '0'); H.add(new Option(v, v)); }
      for (let i = 0; i < 60; i++) { const v = String(i).padStart(2, '0'); Min.add(new Option(v, v)); }
    }

    /* ========= 填充省市区 ========= */
    function populatePlaces() {
      fetch('assets/data/pca.json').then(r => r.ok ? r.json() : Promise.reject(r.status)).then(data => {
        const bp = birthProvince, bc = birthCity, bd = birthDistrict;
        const cp = currentProvince, cc = currentCity, cd = currentDistrict;
        Object.keys(data).forEach(p => { bp.add(new Option(p, p)); cp.add(new Option(p, p)); });

        bp.onchange = () => {
          bc.length = 1; bd.length = 1; bc.style.display = ''; bd.style.display = 'none';
          (Object.keys(data[bp.value] || {})).forEach(c => bc.add(new Option(c, c))); rebuildFancy([bc, bd]);
        };
        bc.onchange = () => {
          bd.length = 1; bd.style.display = '';
          (data[bp.value]?.[bc.value] || []).forEach(d => bd.add(new Option(d, d))); rebuildFancy([bd]);
        };

        cp.onchange = () => {
          cc.length = 1; cd.length = 1; cc.style.display = ''; cd.style.display = 'none';
          (Object.keys(data[cp.value] || {})).forEach(c => cc.add(new Option(c, c))); rebuildFancy([cc, cd]);
        };
        cc.onchange = () => {
          cd.length = 1; cd.style.display = '';
          (data[cp.value]?.[cc.value] || []).forEach(d => cd.add(new Option(d, d))); rebuildFancy([cd]);
        };

        rebuildFancy([bp, bc, bd, cp, cc, cd]);
      }).catch(err => console.error('加载地址数据失败：', err));
    }

    /* ========= 自定义下拉（黑金） ========= */
    function wrapFancy(select) {
      const next = select.nextElementSibling;
      if (next && next.classList && next.classList.contains('gx-wrap')) next.remove();

      // 隐藏原生 select（仍保留）
      select.style.position = 'absolute'; select.style.opacity = '0'; select.style.pointerEvents = 'none';
      select.style.width = '0'; select.style.height = '0';

      const wrap = document.createElement('div'); wrap.className = 'gx-wrap';
      const btn = document.createElement('div'); btn.className = 'gx-btn'; btn.textContent = select.options[select.selectedIndex]?.text || select.options[0]?.text || '';
      const list = document.createElement('div'); list.className = 'gx-list';

      [...select.options].forEach((op, i) => {
        const item = document.createElement('div'); item.className = 'gx-item'; item.textContent = op.text;
        if (i === select.selectedIndex) item.classList.add('active');
        item.addEventListener('click', () => {
          select.selectedIndex = i; btn.textContent = op.text;
          list.querySelectorAll('.gx-item').forEach(el => el.classList.remove('active'));
          item.classList.add('active');
          select.dispatchEvent(new Event('change', { bubbles: true }));
          list.style.display = 'none';
        });
        list.appendChild(item);
      });

      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        document.querySelectorAll('.gx-list').forEach(L => { if (L !== list) L.style.display = 'none'; });
        const r = btn.getBoundingClientRect();
        if (list.parentElement !== document.body) document.body.appendChild(list);
        list.style.left = Math.round(r.left) + 'px';
        list.style.top = Math.round(r.bottom + 6) + 'px';
        list.style.width = Math.round(r.width) + 'px';
        list.style.display = (list.style.display === 'block') ? 'none' : 'block';
      });

      const closeList = () => { list.style.display = 'none'; };
      document.addEventListener('click', closeList);
      ['scroll', 'resize'].forEach(evt => window.addEventListener(evt, closeList, { passive: true }));

      select.after(wrap); wrap.appendChild(btn);
    }
    function buildAllFancy() { document.querySelectorAll('.form-bar select').forEach(wrapFancy); }
    function rebuildFancy(arr) { (arr || document.querySelectorAll('.form-bar select')).forEach(wrapFancy); }

    window.addEventListener('DOMContentLoaded', () => {
      populateTime();
      populatePlaces();
      buildAllFancy();

      submitBtn.addEventListener('click', e => {
        e.preventDefault();
        const isDemo = true;
        const params = {
          year: birthYear.value, month: birthMonth.value, day: birthDay.value,
          hour: birthHour.value, minute: birthMinute.value, gender: gender.value,
          birthProvince: birthProvince.value, birthCity: birthCity.value, birthDistrict: birthDistrict.value,
          currentProvince: currentProvince.value, currentCity: currentCity.value, currentDistrict: currentDistrict.value
        };
        if (!params.year || !params.month || !params.day || !params.birthProvince || (params.gender !== "1" && params.gender !== "0")) {
          return alert('请完整选择“出生年月日”“性别”和“出生省”');
        }
        if (isDemo) {
          alert('Static demo: backend not deployed. Results are unavailable.');
          localStorage.removeItem('baziResult');
          sessionStorage.removeItem('baziResult');
          location.href = './result.html';
          return;
        }

        const qs = new URLSearchParams(params).toString();
        fetch('/analyze', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: qs })
          .then(r => r.json()).then(data => {
            if (data.error) { alert(data.error); }
            else { localStorage.setItem('baziResult', JSON.stringify(data)); location.href = './result.html'; }
          }).catch(err => console.error('提交失败：', err));
      });
    });
  </script>

  <!-- 背景特效（保留，可选） -->
  <script src="https://cdn.jsdelivr.net/npm/webgl-fluid@0.3.2/dist/webgl-fluid.min.js"></script>
  <script>
    const canvas = document.getElementById('bgCanvas'); let useFluid = false, fluid;
    if (window.Fluid) {
      useFluid = true;
      fluid = new Fluid(canvas, { SIM_RESOLUTION: 128, DYE_RESOLUTION: 512, DENSITY_DISSIPATION: 1.02, VELOCITY_DISSIPATION: 0.98, PRESSURE: 0.8, CURL: 30, SPLAT_RADIUS: 0.005, SHADING: false, COLORFUL: false, BLOOM: true, BLOOM_INTENSITY: 0.05, SUNRAYS: false });
      const resize = () => fluid.resize(innerWidth, innerHeight); addEventListener('resize', resize); resize();
      setInterval(() => fluid.splat(.5, .5, 1, .5, 0), 200);
      addEventListener('mousemove', e => { const r = canvas.getBoundingClientRect(); const x = (e.clientX - r.left) / r.width; const y = 1 - (e.clientY - r.top) / r.height; fluid.splat(x, y, 1, .5, 0); });
    }
    const ctx = canvas.getContext('2d'); let W, H; function resize2d() { W = canvas.width = innerWidth; H = canvas.height = innerHeight } addEventListener('resize', resize2d); resize2d();
    const particles = Array.from({ length: 800 }, () => ({ x: W / 2, y: H / 2, vx: 0, vy: 0, life: 0, size: Math.random() * 2 + 1 }));
    let mx = W / 2, my = H / 2; addEventListener('mousemove', e => { mx = e.clientX; my = e.clientY; if (useFluid) return; });
    function update2d() { particles.forEach(p => { if (p.life <= 0) { p.x = mx; p.y = my; const a = Math.random() * Math.PI * 2, s = Math.random() * 3 + 1; p.vx = Math.cos(a) * s; p.vy = Math.sin(a) * s; p.life = Math.random() * 100 + 50; } p.x += p.vx; p.y += p.vy; p.life--; }); }
    function draw2d() {
      // 不再铺黑色渐变，直接清空即可
      ctx.clearRect(0, 0, W, H);

      // 使用“叠加”模式让粒子发光，而不遮挡底图
      ctx.globalCompositeOperation = 'lighter';

      particles.forEach(p => {
        const a = Math.min(1, p.life / 150);
        ctx.fillStyle = `rgba(255,200,100,${a * 0.6})`;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size, 0, 2 * Math.PI);
        ctx.fill();
      });

      // 还原合成模式
      ctx.globalCompositeOperation = 'source-over';
    }

    (function loop() { if (useFluid) { fluid.update(); fluid.drawColor(); } else { update2d(); draw2d(); } requestAnimationFrame(loop); })();
  </script>
</body>

</html>
